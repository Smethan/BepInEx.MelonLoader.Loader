# Thunderstore Packaging Guide

This guide explains how to package BepInEx.MelonLoader.Loader for distribution on Thunderstore (r2modman).

## Quick Start

1. **Build the project:**
   ```bash
   ./build.sh
   ```

2. **Create an icon (if you don't have one):**
   ```bash
   ./create-icon.py
   # Or with Pillow installed:
   pip install Pillow
   ./create-icon.py --output icon.png
   ```

3. **Package for Thunderstore:**
   ```bash
   # For IL2CPP games (BepInEx 6)
   ./package-thunderstore.py --variant IL2CPP-BepInEx6

   # For Unity Mono games (BepInEx 5)
   ./package-thunderstore.py --variant UnityMono-BepInEx5

   # For Unity Mono games (BepInEx 6)
   ./package-thunderstore.py --variant UnityMono-BepInEx6
   ```

4. **Upload to Thunderstore:**
   - Go to the game's Thunderstore page
   - Click "Upload" in the top menu
   - Upload the generated zip from the `Thunderstore/` directory

## Requirements

### Required Files

Every Thunderstore package needs three files at the root:

1. **manifest.json** - Package metadata (auto-generated by script)
2. **icon.png** - 256x256 PNG image
3. **README.md** - Package description (uses repository README by default)

### Icon Requirements

- **Dimensions:** Exactly 256x256 pixels
- **Format:** PNG
- **Transparency:** Supported but optional
- **Best practices:** Clear borders that work with any background color

## Packaging Script Options

The `package-thunderstore.py` script supports various options:

### Basic Usage

```bash
./package-thunderstore.py --variant IL2CPP-BepInEx6
```

### Advanced Options

```bash
./package-thunderstore.py \
  --variant IL2CPP-BepInEx6 \
  --version 2.1.0 \
  --name MelonLoader_Loader \
  --namespace BepInEx \
  --description "Custom description here" \
  --website https://github.com/BepInEx/BepInEx.MelonLoader.Loader \
  --icon custom-icon.png \
  --readme THUNDERSTORE_README.md \
  --deps "BepInEx-BepInExPack-5.4.21" "Author-Package-1.0.0"
```

### Parameters

| Parameter | Description | Default |
|-----------|-------------|---------|
| `--variant` | Build variant to package (required) | - |
| `--version` | Version number (Major.Minor.Patch) | `2.1.0` |
| `--name` | Package name (no spaces, only a-z A-Z 0-9 _) | `MelonLoader_Loader` |
| `--namespace` | Thunderstore namespace/team name | `BepInEx` |
| `--description` | Short description (max 250 chars) | Auto-generated |
| `--website` | Project website URL | GitHub repo |
| `--deps` | Space-separated list of dependencies | `[]` |
| `--icon` | Path to custom icon.png | `icon.png` |
| `--readme` | Path to custom README.md | `README.md` |
| `--output-dir` | Directory containing build outputs | `Output` |
| `--thunderstore-dir` | Output directory for packages | `Thunderstore` |

## Build Variants

Choose the appropriate variant for your target platform:

### IL2CPP-BepInEx6
- **Target:** IL2CPP games
- **BepInEx Version:** 6.x
- **Framework:** .NET Standard 2.1
- **Use cases:** Modern Unity games using IL2CPP scripting backend

### UnityMono-BepInEx5
- **Target:** Unity Mono games
- **BepInEx Version:** 5.x
- **Framework:** .NET 3.5
- **Use cases:** Older Unity games, games requiring BepInEx 5

### UnityMono-BepInEx6
- **Target:** Unity Mono games
- **BepInEx Version:** 6.x
- **Framework:** .NET 3.5
- **Use cases:** Unity Mono games using the newer BepInEx 6

## Package Structure

The script creates a package with the following structure:

```
BepInEx-MelonLoader_Loader-{variant}-{version}.zip
├── icon.png                                    # 256x256 icon
├── manifest.json                               # Thunderstore metadata
├── README.md                                   # Package description
├── BepInEx/
│   └── plugins/
│       └── BepInEx.MelonLoader.Loader/
│           ├── BepInEx.MelonLoader.Loader.*.dll
│           └── BepInEx.MelonLoader.Loader.*.deps.json
└── MLLoader/
    └── MelonLoader/
        └── Dependencies/
            ├── CompatibilityLayers/
            ├── Il2CppAssemblyGenerator/
            ├── NetStandardPatches/
            └── SupportModules/
```

## Manifest.json Format

The generated manifest follows Thunderstore's package format:

```json
{
    "name": "MelonLoader_Loader",
    "version_number": "2.1.0",
    "website_url": "https://github.com/BepInEx/BepInEx.MelonLoader.Loader",
    "description": "BepInEx loader plugin for running MelonLoader mods",
    "dependencies": [
        "BepInEx-BepInExPack-5.4.21"
    ]
}
```

### Important Notes

- **name:** Cannot be changed after first upload (becomes part of package ID)
- **version_number:** Must follow semantic versioning (Major.Minor.Patch)
- **description:** Maximum 250 characters
- **dependencies:** Format is `"Author-PackageName-Version"`

## Dependencies

Common dependencies you might want to specify:

### For BepInEx 5 (Unity Mono)
```bash
--deps "BepInEx-BepInExPack-5.4.21"
```

### For BepInEx 6 (Unity Mono)
```bash
--deps "BepInEx-BepInExPack_Unity_Mono-6.0.0"
```

### For BepInEx 6 (IL2CPP)
```bash
--deps "BepInEx-BepInExPack_IL2CPP-6.0.0"
```

## Creating a Custom Icon

### Using the Helper Script

```bash
# Install Pillow (required)
pip install Pillow

# Create placeholder icon
./create-icon.py

# Create icon at custom location
./create-icon.py --output custom/path/icon.png
```

### Manual Creation

You can create a custom icon using any image editor:

1. Create a 256x256 pixel image
2. Design your icon (consider visibility on both light and dark backgrounds)
3. Export as PNG format
4. Save as `icon.png` in the repository root

**Recommended tools:**
- GIMP (free, cross-platform)
- Photoshop
- Figma
- Inkscape (for vector graphics)

## Troubleshooting

### "Icon validation failed"

- Ensure the icon is exactly 256x256 pixels
- Verify it's in PNG format (not JPEG or other formats)
- Install Pillow for validation: `pip install Pillow`

### "Build file not found"

- Run `./build.sh` first to build the project
- Check that `Output/MLLoader-{variant}-v{version}.zip` exists
- Verify the version matches what you're packaging

### "Missing required files"

The script will extract files to `Thunderstore/temp_{variant}/` so you can:
1. Add the missing icon.png or README.md
2. Manually create the zip file from that directory
3. Fix the issue and re-run the script

### "Package may not be fully compatible"

This warning (NU1701) appears when:
- MelonLoader package was built for .NET Framework but used in .NET Standard 2.1
- This is expected and should work fine
- The warning can be safely ignored

## Best Practices

### Version Numbering

Follow semantic versioning:
- **Major** (X.0.0): Breaking changes, incompatible with previous versions
- **Minor** (0.X.0): New features, backward compatible
- **Patch** (0.0.X): Bug fixes, backward compatible

### README Content

Your README should include:
- Clear description of what the mod does
- Installation instructions
- Configuration options
- Known issues or limitations
- Credits and license information

### Testing Before Upload

1. Test the package with r2modman locally:
   - Extract to game directory manually
   - Verify files are in correct locations
   - Test with actual MelonLoader mods

2. Check file sizes:
   - Thunderstore has a 5GB limit (soft limit)
   - Keep packages as small as possible
   - Remove unnecessary debug symbols if size is an issue

## Example Workflow

Complete workflow for creating and uploading a package:

```bash
# 1. Update version in csproj files if needed
# 2. Build the project
./build.sh

# 3. Create/update icon if needed
./create-icon.py

# 4. Package for your target platform
./package-thunderstore.py --variant IL2CPP-BepInEx6 --version 2.1.0

# 5. Check the output
ls -lh Thunderstore/

# 6. Test locally (optional but recommended)
# Extract Thunderstore/BepInEx-MelonLoader_Loader-IL2CPP-BepInEx6-2.1.0.zip
# Copy to game directory manually and test

# 7. Upload to Thunderstore
# Visit the game's Thunderstore page and upload the zip
```

## Resources

- [Thunderstore Package Format Documentation](https://thunderstore.io/package/create/docs/)
- [Thunderstore Wiki](https://wiki.thunderstore.io/)
- [r2modman GitHub](https://github.com/ebkr/r2modmanPlus)
- [BepInEx Documentation](https://docs.bepinex.dev/)
- [MelonLoader Documentation](https://melonwiki.xyz/)

## License

This packaging script is part of the BepInEx.MelonLoader.Loader project and follows the same Apache 2.0 license.
